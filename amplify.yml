version: 1
backend:
  phases:
    preBuild:
      commands:
        - npm install -g @aws-amplify/cli@6.4.0 yarn # pinned known working version
        - aws configure set cli_follow_urlparam false # fix for parameter store when storing URLs: https://github.com/aws/aws-cli/issues/2507
        - export AWS_BRANCH=$(echo ${AWS_BRANCH} | tr "/" "-" | cut -c1-20) # prevent common and long git branch names (feat/something) to create an invalid stack/resource name
    build:
      commands:
        - '# Execute Amplify CLI with the helper script'
        - amplifyPush --simple
frontend:
  phases:
    preBuild:
      commands:
        - yarn
        - yarn global add gatsby
    build:
      commands:
        - yarn build --verbose
  artifacts:
    baseDirectory: public
    files:
      - '**/*'
